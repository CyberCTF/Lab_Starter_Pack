---
description: Enforce MySQL ONLY_FULL_GROUP_BY-safe SQL (MySQL 5.7+/8)
globs: ["build/**/src/**/*.php", "build/**/src/**/*.sql"]
alwaysApply: false
---

# MySQL GROUP BY (ONLY_FULL_GROUP_BY) — Compliance Rules

**Goal**

- Prevent errors like: "Expression #X of SELECT list is not in GROUP BY…" when `sql_mode=ONLY_FULL_GROUP_BY` is enabled (default in MySQL 5.7+/8).

**Rules**

- Any column selected that is not listed in `GROUP BY` must be either:
  - aggregated (COUNT, MIN, MAX, SUM, …), or
  - wrapped with `ANY_VALUE(...)` when an arbitrary value is acceptable.
- Prefer a subquery/CTE to determine the “current” row (e.g., active subscription) before aggregating, instead of mixing JOIN + GROUP BY with non-aggregated columns.
- Do not disable `ONLY_FULL_GROUP_BY` at the server level (no `--sql-mode=` tweaks to remove it).

**Examples**

Incorrect

```sql
SELECT c.customer_id, c.first_name, s.plan_name, COUNT(t.id)
FROM customers c
LEFT JOIN subscriptions s ON s.customer_id = c.customer_id
LEFT JOIN transactions t  ON t.customer_id = c.customer_id
GROUP BY c.customer_id;  -- ⚠ non-aggregated columns not in GROUP BY
```

Correct (explicit aggregation)

```sql
SELECT
  c.customer_id,
  ANY_VALUE(c.first_name) AS first_name,
  ANY_VALUE(s.plan_name)  AS plan_name,
  COUNT(t.id)             AS transaction_count
FROM customers c
LEFT JOIN subscriptions s ON s.customer_id = c.customer_id
LEFT JOIN transactions t  ON t.customer_id = c.customer_id
GROUP BY c.customer_id;
```

Correct (select expected subscription first, then aggregate)

```sql
WITH current_sub AS (
  SELECT s.*
  FROM subscriptions s
  WHERE s.customer_id = ? 
  ORDER BY s.updated_at DESC
  LIMIT 1
)
SELECT
  c.customer_id,
  c.first_name,
  cs.plan_name,
  COUNT(t.id) AS transaction_count
FROM customers c
LEFT JOIN current_sub cs ON cs.customer_id = c.customer_id
LEFT JOIN transactions t  ON t.customer_id = c.customer_id
GROUP BY c.customer_id, c.first_name, cs.plan_name;
```

**Self-check (optional)**

- Search for `GROUP BY` with SELECTs containing common non-aggregated columns:
  - If `GROUP BY` includes only one key (e.g., `customer_id`), manually verify that all other selected columns are either aggregated or wrapped in `ANY_VALUE(...)`.

**Notes**

- `ANY_VALUE(...)` is supported in MySQL 8+. On older versions, use MIN/MAX (as fits business logic) or rewrite with subqueries.

