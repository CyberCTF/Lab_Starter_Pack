---
description: PHP code quality guardrails — syntax, linting, and error checking
globs: ["**/*.php"]
alwaysApply: false
---

# PHP Code Quality Verification Protocol

## Core Principle

Your primary task processing includes a **mandatory final verification stage** that ensures all PHP files (`.php`) in the project are correctly coded, syntactically valid, and free of errors. You are NOT to consider your overall task complete until this verification stage confirms that all PHP code is error-free.

## Phase 1: Primary Task Execution

1. Address the user's main request as you normally would: perform analysis, make code changes, call tools, and run applications/tests in sub-terminals if the main task requires it.
2. Leverage your ability to read outputs/errors from these sub-terminals to make iterative fixes during _this_ primary phase.

## Phase 2: Mandatory PHP Code Verification

**This phase is executed automatically after Phase 1 and is a strict, non-negotiable requirement.**

### Step 1: Identify All PHP Files

1. Use file system tools to find all files with `.php` extension in the project workspace.
2. Create a comprehensive list of all PHP files that need verification.

### Step 2: Syntax Validation

For each PHP file identified:

1. **Check PHP Syntax:**

   - Use `php -l <file>` to verify syntax (lint check).
   - This will check for parse errors, syntax errors, and basic PHP validity.
   - If syntax errors are found, you MUST fix them before proceeding.

2. **Report any syntax errors found:**
   - Document the file path and the specific error message.
   - Fix syntax errors immediately.

### Step 3: Linting and Code Quality Checks

For each PHP file:

1. **Run Linters (if available):**

   - Try running `phpstan`, `psalm`, `phpcs` (PHP_CodeSniffer), or `php-cs-fixer` on the files if these tools are available in the environment.
   - If linters are not available, perform manual code review for:
     - Undefined variables
     - Unused includes/requires
     - Missing includes/requires
     - Syntax inconsistencies
     - Missing semicolons
     - Incorrect bracket/parentheses matching

2. **Check for Common Errors:**
   - Undefined variables (especially with error_reporting enabled)
   - Missing required includes/requires (require, include, require_once, include_once)
   - Circular dependency issues
   - Type inconsistencies (if type hints are present)
   - Missing semicolons
   - Missing parentheses, brackets, or quotes
   - SQL injection vulnerabilities (if database queries are present)
   - XSS vulnerabilities (if output is not properly escaped)

### Step 4: Runtime Error Detection

1. **Include/Require Verification:**

   - For each PHP file, verify that all `require`, `include`, `require_once`, and `include_once` statements reference files that exist and are accessible.
   - Check that all included/required files exist and are properly referenced (relative or absolute paths).
   - Verify that autoloaded classes can be resolved (if using Composer autoloading).

2. **Basic Execution Check (where applicable):**
   - For scripts that can be executed safely, perform a dry-run or minimal execution check using `php -l` or `php --syntax-check`.
   - Verify that the code can at least be parsed and initialized without fatal errors.
   - Check for undefined constants, functions, or classes that would cause runtime errors.

### Step 5: Error Resolution Loop

1. **If errors are found:**

   - Document each error clearly (file path, line number if available, error type, error message).
   - Fix each error systematically.
   - Re-run verification after each fix.
   - Continue until all errors are resolved.

2. **Iterative Process:**
   - After fixing errors, re-run Steps 2-4 to ensure no new errors were introduced.
   - Continue this loop until verification passes completely.

## Phase 3: Task Completion Criteria

**The task is considered complete ONLY when:**

1. ✅ All PHP files have been identified and verified.
2. ✅ No syntax errors exist in any PHP file.
3. ✅ No linting errors or warnings exist (or all critical issues have been resolved).
4. ✅ All includes/requires are resolvable and valid.
5. ✅ No undefined variables or names are detected.
6. ✅ All code passes basic static analysis checks.

**If any of these criteria are not met, the task is NOT complete, and you MUST continue fixing issues until all criteria are satisfied.**

## Final Verification Report

Before concluding, provide a summary report:

- **Total PHP files checked:** [number]
- **Files with errors found:** [number] (must be 0)
- **Errors fixed:** [list of fixes made]
- **Final status:** ✅ All PHP code is error-free and correctly coded

## Overriding Default Behavior

This entire "PHP Code Verification" process (Phase 2 and Phase 3) is a **strict, non-negotiable requirement** that overrides any default tendency you have to end the conversation after completing Phase 1. The task is only finished when all PHP code verification checks pass without errors. Your "sense of completion" for the original request is deferred until this verification phase confirms zero errors.
